<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Reset Password</title>
    <link rel="stylesheet" href="css/auth.css" />
    <style>
        .password-rules li {
            list-style: none;
            padding-left: 1.2em;
            position: relative;
        }
        .password-rules li::before {
            content: "❌";
            position: absolute;
            left: 0;
        }
        .password-rules li.valid::before {
            content: "✅";
            color: green;
        }
        .password-rules li.invalid::before {
            content: "❌";
            color: red;
        }
    </style>
</head>
<body>
<div class="auth-container">
    <!-- Left Panel -->
    <div class="auth-panel gradient">
        <h2>Reset Your Password</h2>
        <p>Please enter a new password for your account</p>
    </div>

    <!-- Right Panel -->
    <div class="auth-panel form-panel">
        <h2>Create New Password</h2>
        <form id="resetForm">
            <input type="password" id="newPassword" placeholder="New Password" required />
            <progress id="strength-meter" max="6" value="0"></progress>
            <ul class="password-rules">
                <li id="rule-length">Min 8 characters</li>
                <li id="rule-lowercase">At least one lowercase letter</li>
                <li id="rule-uppercase">At least one uppercase letter</li>
                <li id="rule-digit">At least one digit</li>
                <li id="rule-special">At least one special character (@$!%*?&-_. )</li>
                <li id="rule-noWhitespace">No spaces</li>
            </ul>
            <button id="resetSubmit" type="submit">Reset Password</button>
        </form>
        <p id="resetMessage" class="message-box" style="display:none;" aria-live="polite"></p>
        <p class="small-text">
            <a href="login.html" class="forgot-link">Back to Log in</a>
        </p>
    </div>
</div>

<!-- JS Scripts -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/passwordUtils.js"></script>
<script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");
    const msg = document.getElementById("resetMessage");

    const pwdInput = document.getElementById("newPassword");
    const strengthMeter = document.getElementById("strength-meter");
    const submit = document.getElementById("resetSubmit");

    pwdInput.addEventListener("input", () => {
        const pwd = pwdInput.value;
        const results = validatePasswordRules(pwd);
        const score = passwordStrengthScore(pwd);
        updatePasswordRulesUI(results);
        strengthMeter.value = score;
    });

    document.getElementById("resetForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const newPassword = pwdInput.value;

        if (!token) {
            UI.showMessage(msg, "❌ Missing or invalid token.", "error");
            return;
        }

        const results = validatePasswordRules(newPassword);
        if (!results.allValid) {
            UI.showMessage(msg, "❌ Password does not meet all requirements.", "error");
            return;
        }

        try {
            UI.setBusy(submit, true);
            await API.http(`/api/auth/reset-password?token=${encodeURIComponent(token)}&newPassword=${encodeURIComponent(newPassword)}`, {
                method: "POST"
            });
            UI.showMessage(msg, "✅ Password reset successful! You can now login.", "success");
        } catch (err) {
            UI.showMessage(msg, err.message || "❌ Reset failed.", "error");
        } finally {
            UI.setBusy(submit, false);
        }
    });
</script>
</body>
</html>
